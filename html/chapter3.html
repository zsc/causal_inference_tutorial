<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第三章：图模型与因果图</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">因果推断教程</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第一章：因果推断导论</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第二章：潜在结果框架</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第三章：图模型与因果图</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第四章：随机实验与因果识别</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第五章：观察性研究中的因果推断</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第六章：工具变量方法</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第七章：断点回归设计</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第八章：双重差分方法</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第九章：中介分析与路径分析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十章：异质性处理效应</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十一章：时间序列因果推断</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十二章：因果发现</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十三章：反事实推理与结构因果模型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十四章：因果推断与机器学习</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第十五章：实践案例与工具</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="_1">第三章：图模型与因果图</h1>
<h2 id="_2">学习目标</h2>
<p>本章将系统介绍因果图这一强大的因果推断工具。通过学习本章，你将：</p>
<ol>
<li>掌握有向无环图（DAG）的基本概念和性质</li>
<li>理解并能够应用d-分离准则判断条件独立性</li>
<li>学会使用后门准则和前门准则识别因果效应</li>
<li>掌握构建因果图的实用方法和原则</li>
<li>能够将因果图应用于实际问题的分析和解决</li>
</ol>
<p>因果图为我们提供了一种直观而严格的方式来表示和推理因果关系。与纯粹的统计模型不同，因果图明确地编码了我们对数据生成过程的假设，使得因果推断变得透明和可验证。</p>
<h2 id="1-dag">1. 有向无环图（DAG）基础</h2>
<h3 id="11">1.1 图的基本概念</h3>
<p>有向无环图（Directed Acyclic Graph, DAG）是因果推断中最重要的工具之一。一个DAG由以下元素组成：</p>
<ul>
<li><strong>节点（Nodes）</strong>：表示变量，可以是观测变量或潜在变量</li>
<li><strong>有向边（Directed Edges）</strong>：表示直接因果关系，从原因指向结果</li>
<li><strong>路径（Path）</strong>：节点之间的连接序列，忽略边的方向</li>
<li><strong>有向路径（Directed Path）</strong>：沿着边的方向从一个节点到另一个节点的路径</li>
</ul>
<p>重要性质：</p>
<ul>
<li><strong>无环性</strong>：不存在从任何节点出发又回到自身的有向路径</li>
<li><strong>父节点</strong>：直接指向某节点的节点集合，记为$PA(X)$</li>
<li><strong>子节点</strong>：某节点直接指向的节点集合</li>
<li><strong>祖先</strong>：可以通过有向路径到达某节点的所有节点</li>
<li><strong>后代</strong>：某节点可以通过有向路径到达的所有节点</li>
</ul>
<h3 id="12">1.2 因果关系的图形表示</h3>
<p>在因果图中，每条有向边$X \rightarrow Y$表示$X$对$Y$有直接因果效应。这种表示基于以下假设：</p>
<p><strong>马尔可夫假设</strong>：给定其父节点，每个节点独立于其非后代节点。数学表示为：
$$X \perp!!!\perp \text{NonDescendants}(X) \mid PA(X)$$
这个假设允许我们将联合分布分解为：
$$P(X_1, X_2, ..., X_n) = \prod_{i=1}^{n} P(X_i \mid PA(X_i))$$</p>
<h3 id="13">1.3 三种基本结构</h3>
<p>因果图中有三种基本的三节点结构，理解这些结构是掌握d-分离的基础：</p>
<h4 id="chain">链结构（Chain）</h4>
<div class="codehilite"><pre><span></span><code>X → Z → Y
</code></pre></div>

<ul>
<li><strong>含义</strong>：X通过Z影响Y（间接因果）</li>
<li><strong>条件独立性</strong>：$X \perp!!!\perp Y \mid Z$</li>
<li><strong>直观理解</strong>：如果我们知道中间变量Z的值，X就不能再通过这条路径影响Y</li>
</ul>
<h4 id="fork">叉结构（Fork）</h4>
<div class="codehilite"><pre><span></span><code>X ← Z → Y
</code></pre></div>

<ul>
<li><strong>含义</strong>：Z是X和Y的共同原因（混杂）</li>
<li><strong>条件独立性</strong>：$X \perp!!!\perp Y \mid Z$</li>
<li><strong>直观理解</strong>：控制共同原因Z后，X和Y变得独立</li>
</ul>
<h4 id="colliderv-structure">对撞结构（Collider/V-structure）</h4>
<div class="codehilite"><pre><span></span><code>X → Z ← Y
</code></pre></div>

<ul>
<li><strong>含义</strong>：Z是X和Y的共同结果</li>
<li><strong>条件独立性</strong>：$X \perp!!!\perp Y$（边际独立）但$X \not\perp!!!\perp Y \mid Z$</li>
<li><strong>直观理解</strong>：X和Y本来独立，但条件在它们的共同结果Z上会产生虚假相关</li>
</ul>
<p><strong>对撞偏差示例</strong>：
考虑"才华"和"外貌"对"被录取"的影响。才华和外貌可能独立，但在被录取的人群中，才华和外貌往往呈负相关（如果才华不够，外貌可能更好，反之亦然）。</p>
<h2 id="2-d-">2. d-分离准则</h2>
<h3 id="21">2.1 路径阻断规则</h3>
<p>d-分离（d-separation）是判断DAG中条件独立性的图形准则。给定条件集Z，从X到Y的路径被阻断当且仅当：</p>
<ol>
<li><strong>路径包含链结构或叉结构</strong>，且中间节点在Z中</li>
<li><strong>路径包含对撞结构</strong>，且对撞节点及其所有后代都不在Z中</li>
</ol>
<p>如果X到Y的所有路径都被Z阻断，则称X和Y被Z d-分离，记为：
$$X \perp_d Y \mid Z$$</p>
<h3 id="22-d-">2.2 d-分离的形式化定义</h3>
<p><strong>定义</strong>：在DAG G中，节点集X和Y被节点集Z d-分离，当且仅当X中任意节点到Y中任意节点的所有路径都被Z阻断。</p>
<p><strong>定理（全局马尔可夫性）</strong>：如果X和Y被Z在DAG G中d-分离，则在任何与G兼容的分布P中，X和Y给定Z条件独立：
$$X \perp_d Y \mid Z \text{ in } G \Rightarrow X \perp!!!\perp Y \mid Z \text{ in } P$$</p>
<h3 id="23-d-">2.3 d-分离算法</h3>
<p>判断X和Y是否被Z d-分离的算法：</p>
<ol>
<li><strong>构造祖先图</strong>：找出X、Y、Z的所有祖先节点</li>
<li><strong>道义化</strong>：将所有指向同一节点的父节点两两连接（无向边）</li>
<li><strong>删除方向</strong>：将所有有向边转为无向边</li>
<li><strong>删除Z节点</strong>：从图中删除Z中的所有节点及其相连的边</li>
<li><strong>检查连通性</strong>：如果X和Y在剩余图中不连通，则d-分离成立</li>
</ol>
<h3 id="24">2.4 实际应用示例</h3>
<p>考虑以下医疗诊断场景：</p>
<div class="codehilite"><pre><span></span><code>吸烟 → 肺癌 → 呼吸困难
  ↓        ↑
基因 → 心脏病 → 胸痛
</code></pre></div>

<p>问题：给定肺癌，吸烟和呼吸困难是否独立？</p>
<ul>
<li>路径：吸烟 → 肺癌 → 呼吸困难</li>
<li>肺癌在条件集中，阻断了这条链</li>
<li>结论：$\text{吸烟} \perp!!!\perp \text{呼吸困难} \mid \text{肺癌}$</li>
</ul>
<h2 id="3">3. 后门准则与前门准则</h2>
<h3 id="31">3.1 后门路径与混杂</h3>
<p><strong>后门路径</strong>：从处理变量T到结果变量Y的路径，其第一条边指向T（即以←开始的路径）。</p>
<p>后门路径产生混杂偏差，因为它们代表了T和Y之间的非因果关联。例如：</p>
<div class="codehilite"><pre><span></span><code>混杂因素Z
    ↙    ↘
   T  →   Y
</code></pre></div>

<p>这里，路径T ← Z → Y是一条后门路径，如果不控制Z，会产生混杂偏差。</p>
<h3 id="32-backdoor-criterion">3.2 后门准则（Backdoor Criterion）</h3>
<p><strong>定义</strong>：给定DAG G中的有序变量对(T, Y)，变量集Z满足后门准则当且仅当：</p>
<ol>
<li>Z不包含T的后代节点</li>
<li>Z阻断了T和Y之间的所有后门路径</li>
</ol>
<p><strong>后门调整公式</strong>：如果Z满足后门准则，则因果效应可以通过以下公式识别：
$$P(Y \mid do(T=t)) = \sum_z P(Y \mid T=t, Z=z) P(Z=z)$$
或对于连续变量：
$$P(Y \mid do(T=t)) = \int P(Y \mid T=t, Z=z) P(Z=z) dz$$
平均因果效应（ACE）：
$$\text{ACE} = E[Y \mid do(T=1)] - E[Y \mid do(T=0)]$$</p>
<h3 id="33">3.3 寻找有效调整集</h3>
<p>并非所有变量集都适合调整。选择调整集的原则：</p>
<ol>
<li><strong>充分性</strong>：必须阻断所有后门路径</li>
<li><strong>最小性</strong>：避免不必要的调整（降低效率）</li>
<li><strong>避免坏控制</strong>：
   - 不要控制T的后代（阻断因果路径）
   - 不要控制对撞节点（打开新的路径）
   - 不要控制中介变量（如果关注总效应）</li>
</ol>
<p><strong>示例</strong>：</p>
<div class="codehilite"><pre><span></span><code>    U₁ → Z₁ → Y
     ↓    ↓    ↑
     T → Z₂ → Z₃
</code></pre></div>

<ul>
<li>Z₁满足后门准则（阻断T ← U₁ → Z₁ → Y）</li>
<li>{Z₁, Z₃}满足后门准则</li>
<li>Z₂不满足（T的后代）</li>
<li>{Z₂, Z₃}不满足（Z₂是T的后代）</li>
</ul>
<h3 id="34-front-door-criterion">3.4 前门准则（Front-door Criterion）</h3>
<p>当所有后门路径都包含不可观测变量时，后门准则失效。前门准则提供了另一种识别策略。</p>
<p><strong>定义</strong>：变量集M满足(T, Y)的前门准则当且仅当：</p>
<ol>
<li>M截断所有从T到Y的有向路径</li>
<li>T到M的所有后门路径被阻断</li>
<li>M到Y的所有后门路径被T阻断</li>
</ol>
<p><strong>前门调整公式</strong>：
$$P(Y \mid do(T=t)) = \sum_m P(M=m \mid T=t) \sum_{t'} P(Y \mid M=m, T=t') P(T=t')$$
<strong>经典示例：吸烟与肺癌</strong></p>
<div class="codehilite"><pre><span></span><code>基因（U，不可观测）
    ↙        ↘
吸烟(T) → 焦油(M) → 肺癌(Y)
</code></pre></div>

<ul>
<li>后门路径T ← U → Y包含不可观测变量U</li>
<li>焦油M满足前门准则</li>
<li>可以通过M识别吸烟对肺癌的因果效应</li>
</ul>
<h3 id="35">3.5 准则的比较与选择</h3>
<p>| 特性 | 后门准则 | 前门准则 |</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>后门准则</th>
<th>前门准则</th>
</tr>
</thead>
<tbody>
<tr>
<td>适用条件</td>
<td>存在可观测的阻断后门路径的变量</td>
<td>存在完全中介路径</td>
</tr>
<tr>
<td>所需变量</td>
<td>混杂因素</td>
<td>中介变量</td>
</tr>
<tr>
<td>识别公式复杂度</td>
<td>简单</td>
<td>复杂</td>
</tr>
<tr>
<td>实践应用</td>
<td>更常见</td>
<td>较少见</td>
</tr>
<tr>
<td>数据需求</td>
<td>较少</td>
<td>较多</td>
</tr>
</tbody>
</table>
<h2 id="4">4. 因果图的构建方法</h2>
<h3 id="41">4.1 基于领域知识的构建</h3>
<p>构建因果图的第一步是利用领域专家知识：</p>
<ol>
<li><strong>识别关键变量</strong>：列出所有相关变量</li>
<li><strong>确定时间顺序</strong>：后发生的事件不能导致先发生的事件</li>
<li><strong>考虑直接因果</strong>：对每对变量，判断是否存在直接因果关系</li>
<li><strong>识别共同原因</strong>：寻找可能同时影响多个变量的因素</li>
<li><strong>检查完整性</strong>：考虑是否遗漏重要的混杂因素</li>
</ol>
<h3 id="42">4.2 时间顺序原则</h3>
<p>时间顺序提供了因果方向的强约束：</p>
<div class="codehilite"><pre><span></span><code><span class="err">时间</span><span class="n">t₁</span><span class="o">:</span><span class="w"> </span><span class="err">教育水平</span>
<span class="w">    </span><span class="err">↓</span>
<span class="err">时间</span><span class="n">t₂</span><span class="o">:</span><span class="w"> </span><span class="err">工作经验</span>
<span class="w">    </span><span class="err">↓</span>
<span class="err">时间</span><span class="n">t₃</span><span class="o">:</span><span class="w"> </span><span class="err">当前收入</span>
</code></pre></div>

<p>注意事项：</p>
<ul>
<li>同时测量的变量仍可能有因果关系</li>
<li>反馈循环需要动态因果模型处理</li>
<li>横截面数据需要更强的假设</li>
</ul>
<h3 id="43">4.3 迭代改进方法</h3>
<p>因果图构建是迭代过程：</p>
<ol>
<li><strong>初始草图</strong>：基于领域知识绘制初始DAG</li>
<li><strong>测试含义</strong>：列出DAG隐含的条件独立性</li>
<li><strong>数据验证</strong>：用数据检验这些独立性</li>
<li><strong>修正调整</strong>：
   - 如果独立性不成立，考虑添加边
   - 如果发现意外独立性，考虑删除边
   - 考虑潜在混杂因素</li>
<li><strong>敏感性分析</strong>：评估不同DAG结构对结论的影响</li>
</ol>
<h3 id="44">4.4 常见模式与结构</h3>
<p><strong>仪器变量模式</strong>：</p>
<div class="codehilite"><pre><span></span><code>Z → T → Y
    ↑
    U（不可观测）
</code></pre></div>

<p><strong>时变处理模式</strong>：</p>
<div class="codehilite"><pre><span></span><code>L₁ → T₁ → L₂ → T₂ → Y
 ↘         ↗ ↘        ↗
   ↘     ↗     ↘    ↗
     ↘ ↗         ↘↗
</code></pre></div>

<p><strong>选择偏差模式</strong>：</p>
<div class="codehilite"><pre><span></span><code>T → Y
 ↘ ↗
  S（样本选择）
</code></pre></div>

<h2 id="5">5. 行业案例：阿里巴巴广告归因模型的因果图设计</h2>
<h3 id="51">5.1 业务背景</h3>
<p>阿里巴巴的广告系统需要准确评估不同广告渠道对最终转化的因果效应。挑战在于：</p>
<ol>
<li><strong>多触点归因</strong>：用户在购买前可能接触多个广告</li>
<li><strong>选择偏差</strong>：不同用户群体倾向于使用不同渠道</li>
<li><strong>时间动态</strong>：广告效果随时间衰减</li>
<li><strong>溢出效应</strong>：一个渠道的广告可能影响其他渠道的效果</li>
</ol>
<h3 id="52">5.2 因果图构建</h3>
<p>阿里巴巴的数据科学团队构建了如下因果图：</p>
<div class="codehilite"><pre><span></span><code>用户特征(U) → 搜索广告曝光(S) → 点击(C₁) → 加购物车(A)
    ↓           ↓                     ↓          ↓
历史行为(H) → 推荐广告曝光(R) → 点击(C₂) → 购买(Y)
    ↓           ↓                     ↓          ↑
    └──────→ 直通车广告(D) ────→ 点击(C₃) ───┘
</code></pre></div>

<p>关键变量：</p>
<ul>
<li>U：用户画像（年龄、性别、消费能力等）</li>
<li>H：历史购买和浏览行为</li>
<li>S, R, D：不同类型的广告曝光</li>
<li>C₁, C₂, C₃：对应的点击行为</li>
<li>A：加入购物车</li>
<li>Y：最终购买转化</li>
</ul>
<h3 id="53">5.3 因果识别策略</h3>
<p><strong>挑战1：用户特征的混杂</strong></p>
<ul>
<li>后门路径：S ← U → Y, R ← U → Y</li>
<li>解决方案：根据用户特征分层，应用后门调整</li>
</ul>
<p><strong>挑战2：历史行为的时变混杂</strong></p>
<ul>
<li>问题：H既影响广告曝光，又影响购买决策</li>
<li>解决方案：使用时间窗口，控制不同时期的历史行为</li>
</ul>
<p><strong>挑战3：广告间的竞争效应</strong></p>
<ul>
<li>观察：搜索广告和推荐广告存在替代关系</li>
<li>处理：构建联合处理模型，评估组合效应</li>
</ul>
<h3 id="54">5.4 实施方案</h3>
<ol>
<li><strong>数据收集</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 伪代码展示数据结构</span>
<span class="n">user_features</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;gender&#39;</span><span class="p">,</span> <span class="s1">&#39;tier_city&#39;</span><span class="p">,</span> <span class="s1">&#39;purchase_power&#39;</span><span class="p">]</span>
<span class="n">ad_exposures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;search_ad&#39;</span><span class="p">,</span> <span class="s1">&#39;recommend_ad&#39;</span><span class="p">,</span> <span class="s1">&#39;p4p_ad&#39;</span><span class="p">]</span>
<span class="n">outcomes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="s1">&#39;add_cart&#39;</span><span class="p">,</span> <span class="s1">&#39;purchase&#39;</span><span class="p">]</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>因果效应估计</strong>：
   - 使用倾向得分匹配控制用户特征
   - 应用工具变量处理未观测混杂
   - 时间序列方法评估动态效应</p>
</li>
<li>
<p><strong>业务洞察</strong>：
   - 搜索广告对高意向用户效果最好（直接效应强）
   - 推荐广告创造需求（通过影响浏览行为的间接效应）
   - 直通车广告的效果依赖于商品质量（异质性效应）</p>
</li>
</ol>
<h3 id="55">5.5 成果与影响</h3>
<p>通过因果图分析，阿里巴巴实现了：</p>
<ol>
<li><strong>归因准确性提升30%</strong>：相比简单的最后点击归因</li>
<li><strong>ROI优化</strong>：识别真正有效的广告渠道</li>
<li><strong>预算分配优化</strong>：基于因果效应而非相关性分配预算</li>
<li><strong>个性化投放</strong>：针对不同用户群体的异质性效应优化</li>
</ol>
<h2 id="_3">本章小结</h2>
<p>本章介绍了因果图这一强大的因果推断工具。关键要点：</p>
<h3 id="_4">核心概念</h3>
<ol>
<li><strong>DAG基础</strong>：节点表示变量，有向边表示直接因果关系，无环性保证时间一致性</li>
<li><strong>三种基本结构</strong>：链（间接效应）、叉（共同原因）、对撞（共同结果）</li>
<li><strong>d-分离准则</strong>：判断条件独立性的图形化方法</li>
</ol>
<h3 id="_5">关键公式</h3>
<ul>
<li><strong>马尔可夫分解</strong>：$P(X_1,...,X_n) = \prod_i P(X_i \mid PA(X_i))$</li>
<li><strong>后门调整</strong>：$P(Y \mid do(T)) = \sum_z P(Y \mid T, Z) P(Z)$</li>
<li><strong>前门调整</strong>：$P(Y \mid do(T)) = \sum_m P(M \mid T) \sum_{t'} P(Y \mid M, T=t') P(T=t')$</li>
</ul>
<h3 id="_6">实践要点</h3>
<ol>
<li>因果图使假设透明化，便于交流和验证</li>
<li>后门准则是最常用的识别策略</li>
<li>构建因果图需要领域知识和数据验证的结合</li>
<li>正确的因果图是有效因果推断的基础</li>
</ol>
<h2 id="_7">练习题</h2>
<h3 id="31_1">练习3.1：基础概念理解</h3>
<p>考虑以下因果图：</p>
<div class="codehilite"><pre><span></span><code>A → B → C
↓       ↑
D → E → F
</code></pre></div>

<p>判断以下条件独立性是否成立：</p>
<ol>
<li>A ⊥ C | B</li>
<li>A ⊥ F | E</li>
<li>B ⊥ E | A</li>
<li>C ⊥ D | {B, E}</li>
</ol>
<p><strong>提示</strong>：对每个独立性声明，找出所有路径并检查是否被条件集阻断。</p>
<details>
<summary>答案</summary>
<ol>
<li>A ⊥ C | B：<strong>成立</strong>。路径A→B→C被B阻断（链结构）。</li>
<li>A ⊥ F | E：<strong>不成立</strong>。路径A→D→E→F中，E只阻断E→F部分，A→D→E未被阻断。</li>
<li>B ⊥ E | A：<strong>不成立</strong>。路径B←A→D→E中，A是叉结构的中心，但D→E部分未被阻断。</li>
<li>C ⊥ D | {B, E}：<strong>成立</strong>。路径C←B←A→D被B阻断，路径C←E←D被E阻断。</li>
</ol>
</details>
<h3 id="32d-">练习3.2：d-分离应用</h3>
<p>给定因果图：</p>
<div class="codehilite"><pre><span></span><code>    U（不可观测）
    ↙    ↘
   X  →  M  →  Y
    ↘        ↗
      Z ───┘
</code></pre></div>

<p>其中U是不可观测变量。判断X和Y是否可以通过以下变量集d-分离：</p>
<ol>
<li>Z = {M}</li>
<li>Z = {Z}</li>
<li>Z = {M, Z}</li>
<li>Z = ∅</li>
</ol>
<p><strong>提示</strong>：注意U是不可观测的，不能被包含在条件集中。</p>
<details>
<summary>答案</summary>
<p>分析所有X到Y的路径：</p>
<ul>
<li>路径1：X → M → Y</li>
<li>路径2：X → Z → Y</li>
<li>路径3：X ← U → Y（后门路径）</li>
</ul>
<ol>
<li>Z = {M}：<strong>不d-分离</strong>。路径1被阻断，但路径2和3未被阻断。</li>
<li>Z = {Z}：<strong>不d-分离</strong>。路径2被阻断，但路径1和3未被阻断。</li>
<li>Z = {M, Z}：<strong>不d-分离</strong>。路径1和2被阻断，但路径3（X ← U → Y）无法阻断因为U不可观测。</li>
<li>Z = ∅：<strong>不d-分离</strong>。存在未阻断的路径。</li>
</ol>
<p>结论：由于存在不可观测的混杂U，X和Y无法被任何可观测变量集d-分离。</p>
</details>
<h3 id="33_1">练习3.3：后门准则识别</h3>
<p>对于处理T和结果Y，考虑以下因果图：</p>
<div class="codehilite"><pre><span></span><code>L₁ → L₂ → Y
↓  ↗  ↓    ↑
T ──→ M ──┘
</code></pre></div>

<p>找出所有满足后门准则的最小调整集。</p>
<p><strong>提示</strong>：首先识别所有后门路径，然后找出能阻断这些路径的最小变量集。</p>
<details>
<summary>答案</summary>
<p>后门路径分析：</p>
<ol>
<li>T ← L₁ → L₂ → Y</li>
<li>T ← L₁ → L₂ → M → Y</li>
</ol>
<p>检查可能的调整集：</p>
<ul>
<li>{L₁}：阻断两条后门路径（在叉结构处），满足后门准则</li>
<li>{L₂}：L₂是T的后代（通过T→M←L₂），不满足条件1</li>
<li>{M}：M是T的后代，不满足条件1</li>
<li>{L₁, L₂}：L₂是T的后代，不满足条件1</li>
</ul>
<p><strong>最小满足后门准则的调整集：{L₁}</strong></p>
</details>
<h3 id="34">练习3.4：前门准则应用（挑战题）</h3>
<p>某研究想评估教育(E)对收入(I)的因果效应，但存在不可观测的能力(A)同时影响两者：</p>
<div class="codehilite"><pre><span></span><code>能力A（不可观测）
    ↙        ↘
教育E → 职业O → 收入I
</code></pre></div>

<p>假设职业O完全中介了教育对收入的影响。验证O是否满足前门准则，如果满足，写出识别公式。</p>
<p><strong>提示</strong>：逐条检查前门准则的三个条件。</p>
<details>
<summary>答案</summary>
<p>检查前门准则的三个条件：</p>
<ol>
<li>
<p><strong>O截断所有E到I的有向路径</strong>：
   - 唯一有向路径：E → O → I
   - O在此路径上，满足✓</p>
</li>
<li>
<p><strong>E到O的所有后门路径被阻断</strong>：
   - 不存在E到O的后门路径（A不直接影响O）
   - 满足✓</p>
</li>
<li>
<p><strong>O到I的所有后门路径被E阻断</strong>：
   - 后门路径：O ← E ← A → I
   - 给定E，此路径被阻断（链结构）
   - 满足✓</p>
</li>
</ol>
<p><strong>结论</strong>：O满足前门准则。</p>
<p>识别公式：
$$P(I \mid do(E=e)) = \sum_o P(O=o \mid E=e) \sum_{e'} P(I \mid O=o, E=e') P(E=e')$$</p>
</details>
<h3 id="35_1">练习3.5：构建因果图（开放题）</h3>
<p>为以下场景构建合理的因果图：</p>
<p>一个在线教育平台想评估"视频质量"对"完课率"的影响。已知因素包括：</p>
<ul>
<li>学生特征（年龄、教育背景）</li>
<li>课程难度</li>
<li>视频质量（清晰度、音质）</li>
<li>学习时长</li>
<li>完课率</li>
<li>课程评分</li>
</ul>
<p>构建因果图并识别评估"视频质量→完课率"因果效应时需要控制的变量。</p>
<p><strong>提示</strong>：考虑时间顺序、直接/间接效应、可能的混杂因素。</p>
<details>
<summary>参考答案</summary>
<p>合理的因果图：</p>
<div class="codehilite"><pre><span></span><code>学生特征 → 课程选择
    ↓         ↓
    ↓    课程难度
    ↓     ↙   ↘
学习时长      视频质量
    ↓     ↘    ↓
    ↓       完课率
    ↓         ↓
    └────→ 课程评分
</code></pre></div>

<p>分析：</p>
<ol>
<li>
<p><strong>混杂因素</strong>：
   - 课程难度（影响视频质量投入和完课率）
   - 学生特征（影响学习投入和完成能力）</p>
</li>
<li>
<p><strong>中介变量</strong>：
   - 学习时长（部分中介视频质量的效果）</p>
</li>
<li>
<p><strong>后门路径</strong>：
   - 视频质量 ← 课程难度 → 完课率
   - 视频质量 ← 课程难度 ← 学生特征 → 学习时长 → 完课率</p>
</li>
<li>
<p><strong>调整策略</strong>：
   - 如果关注总效应：控制{课程难度, 学生特征}
   - 如果关注直接效应：还需控制学习时长</p>
</li>
</ol>
<p>注意：这只是一个可能的答案，实际因果图取决于领域知识和数据验证。</p>
</details>
<h3 id="36">练习3.6：对撞偏差识别（挑战题）</h3>
<p>某公司分析发现，在其高管群体中，技术能力和沟通能力呈负相关。给出可能的因果图解释，并说明这是否意味着提升技术能力会降低沟通能力。</p>
<p><strong>提示</strong>：考虑选择偏差和对撞结构。</p>
<details>
<summary>答案</summary>
<p>因果图解释：</p>
<div class="codehilite"><pre><span></span><code>技术能力 → 晋升为高管 ← 沟通能力
     (T)        (H)        (C)
</code></pre></div>

<p>这是典型的对撞偏差（选择偏差）：</p>
<ol>
<li>
<p><strong>机制</strong>：
   - 技术能力和沟通能力可能本来独立
   - 两者都能促进晋升为高管
   - 在高管样本中观察，产生虚假负相关</p>
</li>
<li>
<p><strong>数学解释</strong>：
   - P(T, C)：总体中T和C独立
   - P(T, C | H=1)：给定是高管，T和C负相关
   - 原因：如果某高管技术能力较弱，其沟通能力必须更强才能晋升</p>
</li>
<li>
<p><strong>因果推断</strong>：
   - 这种负相关不是因果关系
   - 提升技术能力不会降低沟通能力
   - 这是条件在共同结果上导致的统计假象</p>
</li>
<li>
<p><strong>实践启示</strong>：
   - 不能基于高管样本推断技术训练会损害沟通能力
   - 评估训练效果需要实验或使用全员数据
   - 注意样本选择导致的偏差</p>
</li>
</ol>
</details>
<h3 id="37">练习3.7：综合应用题</h3>
<p>某电商平台有如下业务逻辑：</p>
<ul>
<li>用户画像影响推荐算法</li>
<li>推荐算法决定商品曝光</li>
<li>商品曝光影响点击</li>
<li>点击影响购买</li>
<li>用户画像也直接影响购买倾向</li>
<li>商品价格影响点击和购买</li>
<li>存在未观测的用户购买意图</li>
</ul>
<ol>
<li>绘制因果图</li>
<li>识别"推荐算法→购买"的所有路径</li>
<li>确定评估推荐算法效果的识别策略</li>
</ol>
<p><strong>提示</strong>：注意区分总效应和直接效应。</p>
<details>
<summary>答案</summary>
<ol>
<li><strong>因果图</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code>购买意图U（不可观测）
    ↓           ↓
用户画像P → 推荐算法R → 商品曝光E → 点击C → 购买Y
    ↓                         ↑        ↗      ↗
    └─────────────────────────────────────→
                            价格Pr ────────→
</code></pre></div>

<ol start="2">
<li>
<p><strong>R到Y的所有路径</strong>：
   - 有向路径：R → E → C → Y（主要因果路径）
   - 后门路径1：R ← P → Y
   - 后门路径2：R ← P ← U → Y</p>
</li>
<li>
<p><strong>识别策略</strong>：</p>
</li>
</ol>
<p><strong>总效应识别</strong>：</p>
<ul>
<li>需要阻断后门路径</li>
<li>用户画像P满足后门准则（阻断两条后门路径）</li>
<li>调整公式：E[Y|do(R=r)] = Σₚ P(Y|R=r,P=p)P(P=p)</li>
</ul>
<p><strong>直接效应识别</strong>：</p>
<ul>
<li>如果还想分解为直接和间接效应</li>
<li>需要前门准则或中介分析</li>
<li>曝光E和点击C构成中介路径</li>
</ul>
<p><strong>实践建议</strong>：</p>
<ul>
<li>A/B测试：随机分配推荐算法（打破R←P）</li>
<li>倾向得分：基于用户画像匹配</li>
<li>工具变量：利用算法更新时间等外生变化</li>
</ul>
</details>
<h3 id="38">练习3.8：算法设计题（挑战题）</h3>
<p>设计一个算法，给定DAG和两个节点集合X、Y以及条件集Z，判断X和Y是否被Z d-分离。写出伪代码。</p>
<p><strong>提示</strong>：可以使用图的遍历算法，注意对撞节点的特殊处理。</p>
<details>
<summary>答案</summary>
<div class="codehilite"><pre><span></span><code><span class="k">def</span> <span class="nf">is_d_separated</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    判断在DAG中X和Y是否被Z d-分离</span>

<span class="sd">    算法思路：</span>

<span class="sd">    1. 构建道德图（moralized graph）</span>
<span class="sd">    2. 删除Z中的节点</span>
<span class="sd">    3. 检查X和Y的连通性</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Step 1: 找出祖先集合</span>
    <span class="n">ancestors</span> <span class="o">=</span> <span class="n">find_ancestors</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">X</span> <span class="err">∪</span> <span class="n">Y</span> <span class="err">∪</span> <span class="n">Z</span><span class="p">)</span>

    <span class="c1"># Step 2: 构建祖先子图</span>
    <span class="n">ancestral_graph</span> <span class="o">=</span> <span class="n">induced_subgraph</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">ancestors</span><span class="p">)</span>

    <span class="c1"># Step 3: 道德化（连接共同子节点的父节点）</span>
    <span class="n">moral_graph</span> <span class="o">=</span> <span class="n">moralize</span><span class="p">(</span><span class="n">ancestral_graph</span><span class="p">)</span>

    <span class="c1"># Step 4: 转为无向图</span>
    <span class="n">undirected</span> <span class="o">=</span> <span class="n">make_undirected</span><span class="p">(</span><span class="n">moral_graph</span><span class="p">)</span>

    <span class="c1"># Step 5: 删除Z节点</span>
    <span class="n">remaining</span> <span class="o">=</span> <span class="n">remove_nodes</span><span class="p">(</span><span class="n">undirected</span><span class="p">,</span> <span class="n">Z</span><span class="p">)</span>

    <span class="c1"># Step 6: 检查连通性</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">is_connected</span><span class="p">(</span><span class="n">remaining</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">find_ancestors</span><span class="p">(</span><span class="n">dag</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;找出节点集的所有祖先&quot;&quot;&quot;</span>
    <span class="n">ancestors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">while</span> <span class="n">changed</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">ancestors</span><span class="p">):</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
                    <span class="n">ancestors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">ancestors</span>

<span class="k">def</span> <span class="nf">moralize</span><span class="p">(</span><span class="n">dag</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;道德化：连接共同子节点的父节点&quot;&quot;&quot;</span>
    <span class="n">moral</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">dag</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
        <span class="n">parents</span> <span class="o">=</span> <span class="n">dag</span><span class="o">.</span><span class="n">parents</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="c1"># 将所有父节点两两连接</span>
        <span class="k">for</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p2</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p1</span> <span class="o">!=</span> <span class="n">p2</span><span class="p">:</span>
                    <span class="n">moral</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">moral</span>

<span class="c1"># 时间复杂度：O(n³)，其中n是节点数</span>
<span class="c1"># 空间复杂度：O(n²)</span>
</code></pre></div>

</details>
<h2 id="_8">常见陷阱与错误</h2>
<h3 id="1">1. 混淆相关与因果</h3>
<p><strong>错误</strong>：观察到两个变量相关就假设存在因果关系。
<strong>示例</strong>：冰淇淋销量与溺水事件相关，但两者都是由温度（共同原因）导致。
<strong>正确做法</strong>：构建包含所有相关变量的因果图，识别真正的因果路径。</p>
<h3 id="2">2. 对撞节点的错误处理</h3>
<p><strong>错误</strong>：不加区分地控制所有"可能的混杂因素"。
<strong>示例</strong>：</p>
<div class="codehilite"><pre><span></span><code>才华 → 成功 ← 运气
</code></pre></div>

<p>控制"成功"会在"才华"和"运气"间产生虚假相关。
<strong>正确做法</strong>：识别对撞节点，避免不必要的条件化。</p>
<h3 id="3_1">3. 忽视选择偏差</h3>
<p><strong>错误</strong>：基于特定样本得出普遍因果结论。
<strong>示例</strong>：只分析存活公司的成功因素（幸存者偏差）。
<strong>正确做法</strong>：检查样本选择机制，在因果图中明确表示选择过程。</p>
<h3 id="4-over-adjustment">4. 过度调整（Over-adjustment）</h3>
<p><strong>错误</strong>：控制处理变量的后代节点。
<strong>示例</strong>：评估教育对收入的影响时控制职业（中介变量）。
<strong>后果</strong>：阻断了部分或全部因果效应。
<strong>正确做法</strong>：区分总效应和直接效应，明确研究目标。</p>
<h3 id="5-under-adjustment">5. 调整不足（Under-adjustment）</h3>
<p><strong>错误</strong>：遗漏重要的混杂因素。
<strong>示例</strong>：评估药物效果时未控制患者病情严重程度。
<strong>后果</strong>：估计偏差，可能得出错误结论。
<strong>正确做法</strong>：仔细考虑所有可能的后门路径。</p>
<h3 id="6">6. 错误的时间顺序</h3>
<p><strong>错误</strong>：让后发生的事件影响先发生的事件。
<strong>示例</strong>：让"治疗效果"影响"基线特征"。
<strong>正确做法</strong>：严格遵循时间顺序，使用动态因果模型处理反馈。</p>
<h3 id="7">7. 混淆条件独立与边际独立</h3>
<p><strong>错误</strong>：认为边际独立的变量在任何条件下都独立。
<strong>示例</strong>：对撞结构中，X和Y边际独立但给定Z不独立。
<strong>正确做法</strong>：使用d-分离准则系统判断条件独立性。</p>
<h3 id="8">8. 忽视未观测混杂</h3>
<p><strong>错误</strong>：假设所有混杂因素都可观测。
<strong>示例</strong>：遗传因素、个人能力等往往不可直接测量。
<strong>正确做法</strong>：</p>
<ul>
<li>敏感性分析评估未观测混杂的影响</li>
<li>考虑工具变量或前门准则等替代策略</li>
<li>在因果图中明确标注未观测变量</li>
</ul>
<h3 id="9">9. 循环因果的处理不当</h3>
<p><strong>错误</strong>：在静态DAG中表示反馈循环。
<strong>示例</strong>：价格影响需求，需求又影响价格。
<strong>正确做法</strong>：使用时间索引展开循环，或使用动态因果模型。</p>
<h3 id="10">10. 数据驱动的因果图构建</h3>
<p><strong>错误</strong>：完全基于数据相关性构建因果图。
<strong>问题</strong>：相关性无法确定因果方向。
<strong>正确做法</strong>：结合领域知识、时间顺序和数据验证。</p>
<h2 id="_9">最佳实践检查清单</h2>
<h3 id="_10">因果图构建阶段</h3>
<ul>
<li>[ ] <strong>明确研究问题</strong>：清楚定义处理变量和结果变量</li>
<li>[ ] <strong>列举所有相关变量</strong>：包括可观测和不可观测的</li>
<li>[ ] <strong>应用时间顺序</strong>：确保因果方向符合时间逻辑</li>
<li>[ ] <strong>咨询领域专家</strong>：验证因果关系的合理性</li>
<li>[ ] <strong>标注观测状态</strong>：明确哪些变量可观测</li>
<li>[ ] <strong>检查完整性</strong>：是否遗漏重要的混杂因素或中介变量</li>
</ul>
<h3 id="_11">因果识别阶段</h3>
<ul>
<li>[ ] <strong>列出所有路径</strong>：系统地识别处理到结果的所有路径</li>
<li>[ ] <strong>分类路径类型</strong>：区分因果路径和后门路径</li>
<li>[ ] <strong>检查后门准则</strong>：寻找满足后门准则的调整集</li>
<li>[ ] <strong>考虑前门准则</strong>：当后门准则失效时的备选方案</li>
<li>[ ] <strong>评估可识别性</strong>：确认因果效应是否可识别</li>
<li>[ ] <strong>选择最小调整集</strong>：避免不必要的效率损失</li>
</ul>
<h3 id="_12">分析验证阶段</h3>
<ul>
<li>[ ] <strong>测试模型含义</strong>：验证DAG隐含的条件独立性</li>
<li>[ ] <strong>进行敏感性分析</strong>：评估不同DAG结构的影响</li>
<li>[ ] <strong>检查共线性</strong>：调整变量间是否存在强相关</li>
<li>[ ] <strong>评估正面性</strong>：检查倾向得分的重叠</li>
<li>[ ] <strong>记录假设</strong>：明确说明所有识别假设</li>
<li>[ ] <strong>考虑替代解释</strong>：是否存在其他合理的因果图</li>
</ul>
<h3 id="_13">结果解释阶段</h3>
<ul>
<li>[ ] <strong>区分效应类型</strong>：明确是总效应、直接效应还是间接效应</li>
<li>[ ] <strong>说明识别策略</strong>：清楚解释使用的识别方法</li>
<li>[ ] <strong>报告不确定性</strong>：提供置信区间和敏感性分析结果</li>
<li>[ ] <strong>讨论局限性</strong>：承认未观测混杂等潜在问题</li>
<li>[ ] <strong>提供可操作建议</strong>：基于因果分析给出实践指导</li>
<li>[ ] <strong>强调假设重要性</strong>：结论依赖于因果图的正确性</li>
</ul>
<h3 id="_14">工具使用建议</h3>
<ul>
<li>[ ] <strong>使用专门软件</strong>：DAGitty、pgmpy等工具辅助分析</li>
<li>[ ] <strong>版本控制</strong>：记录因果图的演变过程</li>
<li>[ ] <strong>可视化清晰</strong>：确保因果图易于理解和交流</li>
<li>[ ] <strong>代码可重现</strong>：提供分析代码和数据</li>
<li>[ ] <strong>文档完整</strong>：详细记录建模决策和理由</li>
</ul>
<hr />
<p>通过本章的学习，你应该已经掌握了因果图这一强大工具。因果图不仅帮助我们清晰地表达因果假设，还提供了系统的方法来识别因果效应。在下一章中，我们将学习如何通过随机实验来验证这些因果关系。</p>
            </article>
            
            <nav class="page-nav"><a href="chapter2.html" class="nav-link prev">← 第二章：潜在结果框架</a><a href="chapter4.html" class="nav-link next">第四章：随机实验与因果识别 →</a></nav>
        </main>
    </div>
</body>
</html>