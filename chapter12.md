# 第十二章：因果发现

在前面的章节中，我们学习了如何在已知因果结构的情况下进行因果推断。但在许多实际场景中，因果结构本身是未知的。我们需要从观察数据中自动发现变量之间的因果关系——这就是因果发现（Causal Discovery）的任务。本章将介绍主流的因果发现算法，包括基于约束的方法、基于分数的方法和连续优化方法，并探讨如何评估发现的因果结构的质量。

## 12.1 因果发现的基本概念

### 12.1.1 问题定义

因果发现的目标是从观察数据 $\mathcal{D} = \{X^{(1)}, ..., X^{(n)}\}$ 中学习变量集合 $\mathbf{X} = \{X_1, ..., X_p\}$ 之间的因果图结构 $G$。这个任务面临几个根本性挑战：

1. **马尔可夫等价类**：多个不同的DAG可能对应相同的条件独立性关系
2. **隐变量问题**：未观测的混杂因素可能导致虚假的因果关系
3. **因果充分性假设**：我们通常需要假设观测到了所有相关变量
4. **忠实性假设**：DAG中的条件独立性关系需要在数据分布中得到体现

### 12.1.2 识别性与马尔可夫等价类

两个DAG属于同一个马尔可夫等价类，当且仅当它们具有：
- 相同的骨架（无向边结构）
- 相同的v-结构（形如 $A \rightarrow C \leftarrow B$ 的结构，其中A和B不相连）

```
例子：以下三个DAG属于不同的马尔可夫等价类
(a) A → B → C     (b) A ← B → C     (c) A → B ← C
                                           ↓
                                           D

(a)和(b)有相同骨架但无v-结构，属于同一等价类
(c)包含v-结构 A → B ← C，属于不同等价类
```

### 12.1.3 因果发现的假设

**假设1：因果马尔可夫条件**
每个变量在给定其父节点的条件下，与其非后代节点条件独立。

**假设2：忠实性假设（Faithfulness）**
数据分布中的所有条件独立性关系都对应于因果图中的d-分离关系。

**假设3：因果充分性**
不存在未观测的共同原因影响两个或多个观测变量。

## 12.2 基于约束的方法

基于约束的方法通过测试条件独立性来构建因果图。最著名的是PC算法（以其发明者Peter Spirtes和Clark Glymour命名）。

### 12.2.1 PC算法

PC算法分为两个主要阶段：

**阶段1：骨架学习**

1. 从完全连接图开始
2. 对每对节点 $(X_i, X_j)$：
   - 测试 $X_i \perp\!\!\!\perp X_j$
   - 如果独立，移除边 $X_i - X_j$
3. 对每对仍相连的节点 $(X_i, X_j)$：
   - 对所有大小为1的条件集 $S$：测试 $X_i \perp\!\!\!\perp X_j | S$
   - 如果条件独立，移除边并记录分离集 $Sep(X_i, X_j) = S$
4. 逐步增加条件集大小，重复上述过程

**阶段2：方向确定**

1. **识别v-结构**：对每个三元组 $(X_i, X_j, X_k)$，如果 $X_i - X_j - X_k$ 且 $X_i$ 与 $X_k$ 不相连，若 $X_j \notin Sep(X_i, X_k)$，则定向为 $X_i \rightarrow X_j \leftarrow X_k$

2. **应用定向规则**：
   - R1：如果 $A \rightarrow B - C$ 且 $A$ 与 $C$ 不相连，则 $B \rightarrow C$
   - R2：如果 $A \rightarrow B \rightarrow C$ 且 $A - C$，则 $A \rightarrow C$
   - R3：如果存在两条路径 $A - D \rightarrow C$ 和 $A - E \rightarrow C$，且 $D$ 与 $E$ 不相连，则 $A \rightarrow C$

### 12.2.2 FCI算法（Fast Causal Inference）

FCI算法放松了因果充分性假设，允许存在隐变量。它输出的是部分祖先图（PAG），使用额外的边类型：

- $\circ\!\!-\!\!\circ$：边的方向未知
- $\circ\!\!-\!\!>$：可能是直接因果关系或通过隐变量的路径
- $<\!\!-\!\!>$：双向边，表示存在隐混杂

### 12.2.3 条件独立性测试

实际应用中，条件独立性测试的选择至关重要：

**连续变量**：
- 偏相关测试（假设线性高斯）
- 核条件独立性测试（KCIT）
- 基于互信息的测试

**离散变量**：
- $\chi^2$ 独立性测试
- G-test
- 互信息测试

## 12.3 基于分数的方法

基于分数的方法通过优化评分函数来搜索最佳DAG结构。

### 12.3.1 评分函数

常用的评分函数包括：

**BIC分数（贝叶斯信息准则）**：
$$\text{BIC}(G) = \log P(\mathcal{D}|G, \hat{\theta}) - \frac{k}{2}\log n$$

其中 $k$ 是参数数量，$n$ 是样本大小。

**BDeu分数（贝叶斯Dirichlet等价uniform）**：
对于离散变量，使用Dirichlet先验：
$$\text{BDeu}(G) = \log P(\mathcal{D}|G) = \sum_{i=1}^{p} \text{score}_i(Pa_i^G)$$

具有可分解性：每个节点的分数只依赖于其父节点集。

**BGe分数（贝叶斯高斯等价）**：
对于连续高斯变量：
$$\text{BGe}(G) = \log P(\mathcal{D}|G) \propto -\frac{n}{2}\log|\hat{\Sigma}| + \text{penalty}(G)$$

### 12.3.2 GES算法（Greedy Equivalence Search）

GES算法在马尔可夫等价类空间中进行贪婪搜索：

**前向阶段（Forward Phase）**：
1. 从空图开始
2. 贪婪地添加边，每次选择分数提升最大的边
3. 直到分数不再提升

**后向阶段（Backward Phase）**：
1. 贪婪地删除边
2. 每次选择删除后分数提升最大（或下降最小）的边
3. 直到分数不再提升

GES算法的优势：
- 在大样本和忠实性假设下具有一致性
- 搜索空间是等价类而非单个DAG
- 计算效率相对较高

### 12.3.3 动态规划方法

对于小规模问题（$p \leq 25$），可以使用动态规划找到全局最优解：

$$\text{score}^*(U) = \max_{X_i \in U} \left\{ \max_{Pa_i \subseteq U \setminus \{X_i\}} \text{score}_i(Pa_i) + \text{score}^*(U \setminus \{X_i\}) \right\}$$

这种方法保证找到最优DAG，但计算复杂度为 $O(p \cdot 2^p)$。

## 12.4 连续优化方法

近年来，将组合优化问题转化为连续优化问题成为因果发现的新趋势。

### 12.4.1 NOTEARS算法

NOTEARS（NO TEARS - 无环约束的平滑表示）将DAG学习表述为连续优化问题：

**关键创新：无环约束的代数表示**
$$h(W) = \text{tr}(e^{W \circ W}) - p = 0$$

其中 $W$ 是邻接矩阵，$\circ$ 表示Hadamard积。当且仅当 $W$ 对应无环图时，$h(W) = 0$。

**优化问题**：
$$\min_W \frac{1}{2n}\|X - XW\|_F^2 + \lambda \|W\|_1$$
$$\text{s.t. } h(W) = 0$$

使用增广拉格朗日方法求解：
$$\mathcal{L}_{\rho}(W, \alpha) = f(W) + \alpha h(W) + \frac{\rho}{2}h(W)^2$$

### 12.4.2 非线性因果模型

**加性噪声模型（ANM）**：
$$X_j = f_j(Pa_j) + N_j$$

其中 $f_j$ 是非线性函数，$N_j$ 是独立噪声。

**识别性结果**：在温和条件下，如果 $f$ 是非线性的，则因果方向是可识别的（除了高斯噪声+线性函数的情况）。

**RESIT算法（Regression with Subsequent Independence Test）**：
1. 回归：$\hat{Y} = f(X)$
2. 计算残差：$R = Y - \hat{Y}$
3. 测试独立性：$R \perp\!\!\!\perp X$
4. 如果独立，则 $X \rightarrow Y$；否则尝试反向

### 12.4.3 基于VAE的方法

**因果VAE（Causal VAE）**：
将因果结构编码到变分自编码器中：

编码器：$q_{\phi}(Z|X)$
解码器：$p_{\theta}(X|Z)$
因果层：$Z_i = f_i(Pa_i^Z) + \epsilon_i$

目标函数：
$$\mathcal{L} = \mathbb{E}_{q_{\phi}(Z|X)}[\log p_{\theta}(X|Z)] - \text{KL}(q_{\phi}(Z|X)||p(Z)) + \lambda \cdot \text{DAG\_penalty}$$

## 12.5 因果发现的评估

评估因果发现算法的性能是一个挑战，因为真实的因果结构通常是未知的。

### 12.5.1 结构评估指标

**结构汉明距离（SHD）**：
编辑操作（添加、删除、翻转边）的最小数量：
$$\text{SHD} = \text{FP} + \text{FN} + \text{边方向错误数}$$

**精确率与召回率**：
- 精确率：$\text{Precision} = \frac{\text{TP}}{\text{TP} + \text{FP}}$
- 召回率：$\text{Recall} = \frac{\text{TP}}{\text{TP} + \text{FN}}$
- F1分数：$\text{F1} = \frac{2 \cdot \text{Precision} \cdot \text{Recall}}{\text{Precision} + \text{Recall}}$

**结构干预距离（SID）**：
衡量两个因果图在干预分布上的差异：
$$\text{SID}(G, G') = \sum_{i,j} \mathbb{I}[\text{Pa}_j^{do(X_i)}(G) \neq \text{Pa}_j^{do(X_i)}(G')]$$

### 12.5.2 基于干预的评估

当可以进行干预实验时，可以更准确地评估因果结构：

1. **预测干预效果**：使用发现的因果图预测干预效果，与实际观察比较
2. **主动学习**：选择最有信息量的干预来区分候选因果结构

### 12.5.3 基准数据集

**合成数据**：
- 线性高斯模型：容易生成，但过于简化
- 非线性加性噪声模型：更真实，但计算成本高
- 混合模型：包含线性和非线性关系

**半合成数据**：
- 基于真实数据的因果关系
- 保留真实数据的复杂性
- 例如：DREAM挑战赛的基因调控网络

**真实数据**：
- Sachs蛋白质信号网络
- ALARM医疗诊断网络
- 经济时间序列数据

## 12.6 行业案例：华为5G网络故障根因分析

### 背景

华为在部署5G网络时面临复杂的故障诊断挑战。5G网络包含数万个相互依赖的组件，当出现性能下降或服务中断时，快速准确地定位根本原因至关重要。传统的基于规则的故障诊断系统难以处理复杂的依赖关系和新型故障模式。

### 问题定义

**监控指标**：
- 基站性能指标（吞吐量、延迟、丢包率）
- 核心网指标（信令负载、处理延迟）
- 传输网指标（带宽利用率、传输错误）
- 设备指标（CPU使用率、内存、温度）
- 用户体验指标（连接成功率、切换成功率）

**挑战**：
1. 高维度：数千个监控指标
2. 时变性：网络拓扑和流量模式动态变化
3. 隐变量：部分故障原因无法直接观测
4. 快速性要求：需要在分钟级别内定位问题

### 因果发现方案

**阶段1：离线因果图构建**

使用历史数据构建基础因果图：
```
数据预处理：
1. 时间序列对齐和重采样（5分钟粒度）
2. 异常值检测和处理
3. 特征工程（滑动窗口统计量）

算法选择：
- PC-Stable算法：处理高维稀疏图
- 时间序列扩展：考虑时滞效应
- 领域知识约束：禁止某些边（如用户指标→硬件指标）
```

**阶段2：在线根因定位**

当检测到异常时，使用因果图进行根因分析：
```
输入：异常KPI集合 A = {KPI_1, ..., KPI_k}
输出：根因节点集合 R

算法：
1. 在因果图中标记所有异常节点
2. 计算每个节点的责任分数：
   RS(v) = P(A|do(v=abnormal)) - P(A)
3. 使用反向追溯找到最上游的异常节点
4. 验证：模拟修复该节点，预测其他节点恢复情况
```

### 实施细节

**特征工程**：
- 原始指标：直接监控值
- 差分特征：$\Delta X_t = X_t - X_{t-1}$
- 比率特征：实际值/预期值
- 交叉特征：不同层级指标的交互

**因果强度评估**：
使用部分相关系数衡量直接因果强度：
$$\rho_{ij|S} = \frac{\text{Cov}(X_i, X_j | S)}{\sqrt{\text{Var}(X_i|S) \cdot \text{Var}(X_j|S)}}$$

### 结果与收益

**定量结果**：
- 根因定位准确率：从65%提升到89%
- 平均定位时间：从45分钟减少到8分钟
- 误报率：从30%降低到12%
- 覆盖的故障类型：从20种扩展到35种

**业务价值**：
1. **运维效率提升**：减少70%的人工排查时间
2. **服务可用性**：网络可用性从99.95%提升到99.98%
3. **知识沉淀**：自动生成故障传播图谱
4. **预防性维护**：识别潜在故障链路

### 经验教训

1. **数据质量至关重要**：花费40%的时间在数据清洗和对齐
2. **领域知识不可或缺**：纯数据驱动的方法容易产生虚假因果关系
3. **增量学习**：因果图需要持续更新以适应网络变化
4. **可解释性要求**：运维人员需要理解和信任算法结果
5. **多算法融合**：结合PC算法和NOTEARS提高鲁棒性